/*  2012-03-26
    Copyright 2012 Christopher Weiss (cmweiss@gmail.com)

    Suggestions for improvements are appreciated.

    Adapted from the geomagc software and World Magnetic Model of the NOAA
    Satellite and Information Service, National Geophysical Data Center
    http://www.ngdc.noaa.gov/geomag/WMM/DoDWMM.shtml

    Adapted and minified for use here.
*/
function Geomag(g){var d,n=12,m=6378.137,l=6356.7523142,p=6371.2,c=m*m,k=l*l,f=c-k,r=c*c,i=k*k,e=r-i,j=[0,0,0,0,0,0,0,0,0,0,0,0,0],o;function h(a){d=(function(y){var x=y.split("\n"),u=[],t,w,v,s,b;for(t in x){if(x.hasOwnProperty(t)){w=x[t].replace(/^\s+|\s+$/g,"").split(/\s+/);if(w.length===3){v=parseFloat(w[0]);s=w[1];b=w[2]}else{if(w.length===6){u.push({n:parseInt(w[0],10),m:parseInt(w[1],10),gnm:parseFloat(w[2]),hnm:parseFloat(w[3]),dgnm:parseFloat(w[4]),dhnm:parseFloat(w[5])})}}}}return{epoch:v,model:s,modelDate:b,wmm:u}}(a))}function q(u){var z,y,v,t,b,x,B=[j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice()],s=[j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice()],w=[j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice()],a=[j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice(),j.slice()],A=u.wmm;for(z in A){if(A.hasOwnProperty(z)){if(A[z].m<=A[z].n){B[A[z].m][A[z].n]=A[z].gnm;s[A[z].m][A[z].n]=A[z].dgnm;if(A[z].m!==0){B[A[z].n][A[z].m-1]=A[z].hnm;s[A[z].n][A[z].m-1]=A[z].dhnm}}}}a[0][0]=1;for(t=1;t<=n;t++){a[0][t]=a[0][t-1]*(2*t-1)/t;y=2;for(v=0,b=(t-v+1);b>0;b--,v++){w[v][t]=(((t-1)*(t-1))-(v*v))/((2*t-1)*(2*t-3));if(v>0){x=((t-v+1)*y)/(t+v);a[v][t]=a[v-1][t]*Math.sqrt(x);y=1;B[t][v-1]=a[v][t]*B[t][v-1];s[t][v-1]=a[v][t]*s[t][v-1]}B[v][t]=a[v][t]*B[v][t];s[v][t]=a[v][t]*s[v][t]}}w[1][1]=0;o={epoch:u.epoch,k:w,c:B,cd:s}}this.setCof=function(a){h(a);q(d)};this.getWmm=function(){return d};this.setUnnorm=function(a){o=a};this.getUnnorm=function(){return o};this.getEpoch=function(){return o.epoch};this.setEllipsoid=function(a){m=a.a;l=a.b;p=6371.2;c=m*m;k=l*l;f=c-k;r=c*c;i=k*k;e=r-i};this.getEllipsoid=function(){return{a:m,b:l}};this.calculate=function(at,K,ar,aq){if(o===undefined){throw new Error("A World Magnetic Model has not been set.")}if(at===undefined||K===undefined){throw new Error("Latitude and longitude are required arguments.")}function ap(z){return z*(180/Math.PI)}function af(z){return z*(Math.PI/180)}function T(z){z=z||new Date();var aC=z.getFullYear(),aB=365+(((aC%400===0)||(aC%4===0&&(aC%100>0)))?1:0),aD=aB*24*60*60*1000;return z.getFullYear()+(z.valueOf()-(new Date(aC,0)).valueOf())/aD}var t=o.epoch,an=o.k,az=o.c,X=o.cd,G=(ar/3280.8399)||0,x=T(aq)-t,M=af(at),au=af(K),N=Math.sin(au),ay=Math.sin(M),aj=Math.cos(au),H=Math.cos(M),ao=ay*ay,W=H*H,ag,V,U,P,B,E,ae,ax,Y,O,I,w,ai=0,ad=0,al=0,aw=0,y,b,a,J,C,am,ak,R=[0,2,3,4,5,6,7,8,9,10,11,12,13],S=[0,1,2,3,4,5,6,7,8,9,10,11,12],Z=[0,0,0,0,0,0,0,0,0,0,0,0,0],u=[Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice()],F=Z.slice(),Q=Z.slice(),D=Z.slice(),ah=[Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice()],A=[Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice(),Z.slice()],ac,ab,aa,av,s,L,aA,v;F[0]=0;F[1]=N;Q[1]=aj;u[0][0]=0;Q[0]=1;D[0]=1;ah[0][0]=1;ag=Math.sqrt(c-f*ao);V=G*ag;U=((V+c)/(V+k))*((V+c)/(V+k));P=ay/Math.sqrt(U*W+ao);B=Math.sqrt(1-(P*P));E=(G*G)+2*V+(r-e*ao)/(ag*ag);ae=Math.sqrt(E);ax=Math.sqrt(c*W+k*ao);Y=(G+ax)/ae;O=f*H*ay/(ae*ax);for(am=2;am<=n;am++){F[am]=F[1]*Q[am-1]+Q[1]*F[am-1];Q[am]=Q[1]*Q[am-1]-F[1]*F[am-1]}I=p/ae;w=I*I;for(ak=1;ak<=n;ak++){w=w*I;for(am=0,C=(ak+am+1);C>0;C--,am++){if(ak===am){ah[am][ak]=B*ah[am-1][ak-1];A[am][ak]=B*A[am-1][ak-1]+P*ah[am-1][ak-1]}else{if(ak===1&&am===0){ah[am][ak]=P*ah[am][ak-1];A[am][ak]=P*A[am][ak-1]-B*ah[am][ak-1]}else{if(ak>1&&ak!==am){if(am>ak-2){ah[am][ak-2]=0}if(am>ak-2){A[am][ak-2]=0}ah[am][ak]=P*ah[am][ak-1]-an[am][ak]*ah[am][ak-2];A[am][ak]=P*A[am][ak-1]-B*ah[am][ak-1]-an[am][ak]*A[am][ak-2]}}}u[am][ak]=az[am][ak]+x*X[am][ak];if(am!==0){u[ak][am-1]=az[ak][am-1]+x*X[ak][am-1]}y=w*ah[am][ak];if(am===0){b=u[am][ak]*Q[am];a=u[am][ak]*F[am]}else{b=u[am][ak]*Q[am]+u[ak][am-1]*F[am];a=u[am][ak]*F[am]-u[ak][am-1]*Q[am]}ad=ad-w*b*A[am][ak];al+=(S[am]*a*y);ai+=(R[ak]*b*y);if(B===0&&am===1){if(ak===1){D[ak]=D[ak-1]}else{D[ak]=P*D[ak-1]-an[am][ak]*D[ak-2]}J=w*D[ak];aw+=(S[am]*a*J)}}}al=(B===0?aw:al/B);ac=-ad*Y-ai*O;ab=al;aa=ad*O-ai*Y;av=Math.sqrt((ac*ac)+(ab*ab));s=Math.sqrt((av*av)+(aa*aa));L=ap(Math.atan2(ab,ac));aA=ap(Math.atan2(aa,av));if(Math.abs(at)>=55){if(at>0&&K>=0){v=L-K}else{if(at>0&&K<0){v=L+Math.abs(K)}else{if(at<0&&K>=0){v=L+K}else{if(at<0&&K<0){v=L-Math.abs(K)}}}}if(v>180){v-=360}else{if(v<-180){v+=360}}}return{dec:L,dip:aA,ti:s,bh:av,bx:ac,by:ab,bz:aa,lat:at,lon:K,gv:v}};this.calc=this.calculate;this.mag=this.calculate;if(g!==undefined){if(typeof g==="string"){h(g);q(d)}else{if(typeof g==="object"){this.setUnnorm(g)}else{throw new Error("Invalid argument type")}}}};
